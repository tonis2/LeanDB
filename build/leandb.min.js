!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).leandb={})}(this,function(e){"use strict";class t{constructor(e,t,s){return this.createTransaction(e,t,s)}async createTransaction(e,t,s){const n=await e,a=await n.transaction(t,s);return await a}}class s{constructor(e,t,s){this.name=e,this.version=t,this.db=s}async add(e){return new Promise(async(s,n)=>{const a=await new t(this.db,this.name,"readwrite"),r=await a.objectStore(this.name).put(e);r.onerror=(e=>{n(e.target.error.message)}),r.onsuccess=(async e=>{if(this.db.observe&&"sync"!==this.name){const t=await this.db.save_to_sync("add",r.source.name,e.target.result);this.db.onchange&&this.db.onchange(t)}s(e.target.result)})})}delete(e){return new Promise(async s=>{const n=await new t(this.db,this.name,"readwrite"),a=await n.objectStore(this.name).openCursor();a.onsuccess=(async t=>{const n=t.target.result;if(n){if(Object.keys(e).map(t=>Object.is(n.value[t],e[t])).filter(e=>!e).length<1&&(n.delete(),this.db.observe&&"sync"!==this.name)){const e=await this.db.save_to_sync("delete",a.source.name,n.key);this.db.onchange&&this.db.onchange(e)}n.continue()}else s()})})}update(e){return this.value=(s=>new Promise(async n=>{const a=await new t(this.db,this.name,"readwrite"),r=await a.objectStore(this.name).openCursor();r.onsuccess=(async t=>{const a=t.target.result;if(a){if(Object.keys(e).map(t=>Object.is(a.value[t],e[t])).filter(e=>!e).length<1){if(a.update(Object.assign(a.value,s)),this.db.observe&&"sync"!==this.name){const e=await this.db.save_to_sync("update",r.source.name,a.key);this.db.onchange&&this.db.onchange(e)}n(a.value)}a.continue()}else n(a)})})),this}async all(){return new Promise(async e=>{const s=await new t(this.db,this.name,"readwrite");(await s.objectStore(this.name)).getAll().onsuccess=(t=>{e(t.target.result)})})}async search(e,s){return new Promise(async n=>{const a=await new t(this.db,this.name,"readwrite");let r=await a.objectStore(this.name);if(e&&!e.index){const t=r.openCursor(),s=[];t.onsuccess=(async t=>{const a=t.target.result;if(a){Object.keys(e).map(t=>Object.is(a.value[t],e[t])).filter(e=>!e).length<1&&s.push(a.value),a.continue()}else n(s)})}e&&e.index&&((r=r.index(e.index)).getAll(e.key,s).onsuccess=(e=>{n(e.target.result)})),e||(r.getAll(null,s).onsuccess=(e=>{n(e.target.result)}))})}}class n{constructor(e,t,s){return this.name=e,this.version=t,this.start_database(s)}start_database(e){const t=indexedDB.open(this.name,this.version||1);return new Promise((s,n)=>{t.onsuccess=(e=>s(e.target.result)),t.onerror=(e=>n(e.target.result)),e&&(t.onupgradeneeded=(t=>e(t.target.result)))})}}const a={"<":IDBKeyRange.upperBound,">":IDBKeyRange.lowerBound,is:IDBKeyRange.only};e.default=class{constructor(e){this.name=e}async init(e,a){const r=new n(this.name,e,async e=>{(await e.createObjectStore("sync",{keyPath:"id",autoIncrement:!0})).createIndex("date","date",{unique:!1}),Object.entries(a).forEach(async t=>{const s=t[0],n=t[1].split(","),a=/d\++/.test(n[0]);a&&(n[0]=n[0].replace("++",""));const r=await e.createObjectStore(s,{keyPath:n[0],autoIncrement:a});n.forEach(e=>{const t=/&/i.test(e);t&&(e=e.replace("&","")),r.createIndex(e,e,{unique:t})})})});return Object.keys(a).forEach(t=>this[t]=new s(t,e,r)),r.observe=this.observe,r.onchange=this.onchange,this.sync=new s("sync",e,r),this.observe&&(r.save_to_sync=(async(e,s,n)=>{const a=await new t(r,"sync","readwrite"),c={method:e,source:s,key:n,date:(new Date).toISOString()};return await a.objectStore("sync").put(c),c})),this}},e.query=function(e,t){let s=[...e].join(""),[,n,r]=s.match(/^([a-z]+) ([a-z<>]+)/);return{index:n,key:a[r](t)}},Object.defineProperty(e,"__esModule",{value:!0})});
